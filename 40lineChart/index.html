<!DOCTYPE html>
<html lang="">
<head>
<meta charset="UTF-8">
<title>Untitled Document</title>
<meta name="Author" content=""/>
<link href="https://fonts.googleapis.com/css?family=Roboto:400 700" rel="stylesheet">
<script src="http://cdn1.uvnimg.com/de/8b/bcc0a79549b0a3fd3d8f8df5a8f8/d3.v4.min.js"></script>
<style>
  #grafico-linea{
    margin:0 auto;
    max-width: 700px;
    width: 100%;
  }

  .linea {
    fill: none;
    stroke: red;
    stroke-width: 3;
  }

  .area {
    fill:#f7f7f7;
  }

  .bolas{
  fill:red;
  }

  .textos{
    font-family: 'Roboto', sans-serif;
    font-weight: 400;
    font-style: normal;
    font-size: 12px;
    fill: #999 !important;
    text-shadow: 1px 1px 0px #ffffff, -1px -1px 0px #ffffff, 1px 1px 0px #ffffff, -1px -1px 0px #ffffff, 1px 1px 0px #ffffff, -1px -1px 0px #ffffff, 1px 1px 0px #ffffff, -1px -1px 0px #ffffff;
  }

  .axis path {
    stroke: #ada8a8;
    shape-rendering: crispEdges;
  }

  .axis line {
    stroke: #ada8a8;
    shape-rendering: crispEdges;
  }

  .axis text {
    font-family: 'Roboto', sans-serif;
    font-weight: 400;
    font-style: normal;
    font-size: 11px;
    fill: #ada8a8;
  }	
</style>
</head>
<body>		
  <div id="grafico-linea"></div>    
  <script type="text/javascript">

    //Width and height
    var anchoDelGrafico = document.getElementById("grafico-linea").offsetWidth;    
    var w = anchoDelGrafico;
    var h = 400;
    var padding = 40;


		// Formatea la fecha a string para que se lea en un formato comprensible. Todas las opciones se pueden ver en el repositorio de D3 (https://github.com/d3/d3-time-format#locale_format)
		//var formatTime = d3.timeFormat("%e %B");

		//var formatTime = d3.timeFormat("%d" + " de " + "%B" + " de " +  "%Y");
		//formatTime(new Date); // "June 30, 2015"


		//Este método de D3 coge nuestros datos de tiempo y los convierte a fechas reales
		var parseTime = d3.timeParse("%Y,%m");//En el paréntesis le digo cómo voy a pasarle los datos, en este caso le voy a pasar el año y el mes separados por una coma: "1958,3"
		//%Y año con cuatro dígitos
		//%y año con dos dígitos
		//%m mes con dos dígitos
		//%d día con dos dígitos
		console.log(parseTime("2015,05"))

		//Para convertir los datos del CSV a Fechas y Números
		var rowConverter = function(d){
			var tempFecha = d.year + "," + d.month;
			d.nuevaFecha = tempFecha;
		    return {
		        date : parseTime(d.nuevaFecha),
		        //date: new Date(+d.year, (+d.month - 1)) Es lo mismo que la línea anterior
		        average : parseFloat(d.average)
		    };
		}

		//Load in data
		d3.csv("mauna_loa_co2_monthly_averages.csv", rowConverter, function(data) {

			var dataset = data;

			//Print data to console as table, for verification
			//console.table(dataset, ["date", "average"]);

			//Create scale functions
			xScale = d3.scaleTime()
						   .domain([
								d3.min(dataset, function(d) { return d.date; }),
								d3.max(dataset, function(d) { return d.date; })
							])
						   .range([padding, w - padding]);

			yScale = d3.scaleLinear()
							.domain([0, d3.max(dataset, function(d) { return d.average; })])
							.range([h - padding, padding]);

			//Axis
			var xAxis = d3.axisBottom()
						  .scale(xScale)
						  .ticks(5);//ticks son las barritas de la escala

			//Define Y axis
			var yAxis = d3.axisLeft()
					   .scale(yScale)
					   .ticks(10)
					   .tickSize(-w);     

			//Define line generator
			line = d3.line()
						.defined(function(d){ return d.average >= 0})//elimina los valores negativos de los datos
						.x(function(d) { return xScale(d.date); })
						.y(function(d) { return yScale(d.average); });

			//Define area generators
			area = d3.area()
						.defined(function(d) { return d.average >= 0; })
						.x(function(d) { return xScale(d.date); })
						.y0(function() { return yScale.range()[0]; })
						.y1(function(d) { return yScale(d.average); });			
		
			//Create SVG element
			var svg = d3.select("#grafico-linea")
						.append("svg")
						.attr("width", w)
						.attr("height", h);

			//Create areas
			svg.append("path")
				.datum(dataset)
				.attr("class", "area")
				.attr("d", area);

			//Pinta la línea
			svg.append("path")
				.datum(dataset)
				.attr("class", "linea")
				.attr("d", line);

			//Pintar axis
			var ejeX = svg.append("g")
						  .attr("class", "axis")
						  .attr("transform", "translate(0," + (h - padding) + ")")
						  .call(xAxis);

			var ejeY = svg.append("g")
						  .attr("class", "axis")
						  .attr("transform", "translate(" + padding + ",0)")
						  .call(yAxis);	

			var circulosDatos = svg.select
			
			var bolas = svg.selectAll("circle")
					           .data(dataset)
					           .enter()
					           .append("circle")
					           .attr("cx", function(d){
					            return xScale(d.date)
						        })
					           .attr("cy", function(d){
					            return yScale(d.average)
						        })
					           .attr("r", 3)
					           .classed("bolas", true);

			var textosBolas = svg.selectAll(".textos")
						         .data(dataset)
						         .enter()
						         .append("text")
						         .text(function(e){
						         	console.log(e)
						         	if (e.average > 40){
						         		var datoPintado = e.average;
						         	}
						            return datoPintado
						       	 })
						         .attr("x", function(e){
						            return xScale(e.date)
						         })
						         .attr("y", function(e){
						            return yScale(e.average + 2)
						         })
						         .attr("class", "textos");		           			  
		});























	</script>		
</body>
</html>